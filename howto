Install nacl toolchain in $HOME/root/ (so that compilers are in $HOME/root/nacl-sdk/bin).

Grab nacl64/lib/libstdc++.a from toolchain r4777 and overwrite the one in the your toolchain with it.

If there is no nacl64/lib/libnosys.a in the toolchain, create an empty one.

Build and install all naclports, don't forget the patch.
NACL_TOOLCHAIN_ROOT=$HOME/root/nacl-sdk ./nacl-install-all-bitsize.sh 64

Build and install the following packages from http://github.com/eugenis.
Most of them have a build.sh script in the repository root. "A -> B" mean B depends on A.
  bzip2 -> boost
  glib -> pango
  SDL_mixer
  SDL_image
  SDL_ttf
  SDL_net

Get wesnoth-1.9.5 from official site, apply the patch (wesnoth-1.9.5-nacl.patch), run build.sh.


# Optional: Significantly reduces the amount of flood from sel_ldr.
cp /etc/localtime $HOME/root/nacl-sdk/nacl64/etc/localtime

# Optional(?): mkdir is not implemented in NaCl/GLibC at the moment
mkdir -p ./.wesnoth1.9/editor/maps  ./.wesnoth1.9/data/add-ons ./.wesnoth1.9/saves ./.wesnoth1.9/persist

# In the NaCl tree, build the loader
./scons platform=x86-64 --mode=dbg-linux sel_universal sel_ldr ncval_stubout sdl_sel_universal=1

# Stub out all invalid instructions in the wesnoth binary.
./scons-out/dbg-linux-x86-64/staging/ncval_stubout @WESNOTH_BUILD_DIR@/wesnoth-debug -o wesnoth-debug-stubout

# Run wesnoth
scons-out/dbg-linux-x86-64/staging/sel_universal -a -c  -- wesnoth-debug-stubout -d < src/trusted/sniversal/launch.stdin

----------------

It kind of works.

* Very slow and the sound is glitchy, probably because of the busy loop in the SDL port (CallOnMainThread stuff).
* For some reason it requests an 8-bit video mode from SDL. Colors look weird.
* It crashes on exit.
* Fontconfig looks for its files in the host system.
* The resulting binary does not pass NaCl validator. It does after ncval_stubout!
* Need to package all required files and add some kind of a JS bridge to run this in the browser.
* I see an empty square in place of the introduction text at the start of the first campain. Does not prevent you from playing, all controls work fine.

---------------

As there is no support for opendir() in NaCl (at least for now), preprocess.py script can be used to resolve includes in Wesnoth's *.cfg.
Usage:
mv usr/share/wesnoth/data/hardwired/language.cfg usr/share/wesnoth/data/hardwired/language.cfg.orig
./preprocess.py usr/share/wesnoth/data/hardwired/language.cfg.orig usr/share/wesnoth/data >usr/share/wesnoth/data/hardwired/language.cfg

